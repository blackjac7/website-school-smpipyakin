// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================
// AUTH & USER MANAGEMENT (Based on your dbdiagram)
// =============================================

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String?  @unique  // Added for auth compatibility
  password  String
  role      UserRole

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  siswa               Siswa?
  kesiswaan           Kesiswaan?
  newsArticles        News[]               @relation("NewsAuthor")
  schoolActivities    SchoolActivity[]     @relation("ActivityCreator")
  osisActivities      OsisActivity[]       @relation("OsisActivityCreator")
  notifications       Notification[]
  latenessRecords     LatenessRecord[]     @relation("LatenessRecorder")

  @@map("users")
}

// =============================================
// STUDENT MANAGEMENT
// =============================================

model Siswa {
  id          String      @id @default(uuid())
  userId      String      @unique
  nisn         String      @unique
  name        String?
  image       String?
  year        Int?
  gender      GenderType
  osisAccess  Boolean     @default(false) @map("osis_access")

  // Profile fields
  email       String?
  phone       String?
  address     String?
  birthDate   DateTime?   @map("birth_date")
  birthPlace  String?     @map("birth_place")
  parentName  String?     @map("parent_name")
  parentPhone String?     @map("parent_phone")
  class       String?
  
  // QR Code for lateness tracking
  qrToken     String?     @unique @map("qr_token")

  // Timestamps
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievements    StudentAchievement[]
  works           StudentWork[]
  latenessRecords LatenessRecord[]

  // Religious Activities
  menstruationRecords WorshipMenstruationRecord[]
  adzanSchedules      WorshipAdzanSchedule[]
  carpetAssignments   WorshipCarpetAssignment[]

  @@map("siswa")
}

model Kesiswaan {
  id           String      @id @default(uuid())
  userId       String      @unique
  nip          String      @unique
  name         String?
  gender       GenderType
  statusActive Boolean     @default(true) @map("status_active")

  // Timestamps
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Relations
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("kesiswaan")
}

// =============================================
// PPDB (Penerimaan Peserta Didik Baru)
// =============================================

model PPDBApplication {
  id                String              @id @default(uuid())
  name              String
  nisn              String              @unique
  gender            GenderType?
  birthPlace        String?             @map("birth_place")
  birthDate         DateTime?           @map("birth_date")
  address           String?
  asalSekolah       String?             @map("asal_sekolah")
  parentContact     String?             @map("parent_contact")
  parentName        String?             @map("parent_name")
  parentEmail       String?             @map("parent_email")
  status            PPDBStatus          @default(PENDING)
  feedback          String?

  // Document Cloudinary URLs
  ijazahUrl         String?             @map("ijazah_url")
  aktaKelahiranUrl  String?             @map("akta_kelahiran_url")
  kartuKeluargaUrl  String?             @map("kartu_keluarga_url")
  pasFotoUrl        String?             @map("pas_foto_url")
  retries           Int                 @default(0)

  // Timestamps
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@map("ppdb_applications")
}

// =============================================
// CONTENT MANAGEMENT
// =============================================

model News {
  id                 String         @id @default(uuid())
  title              String
  date               DateTime
  content            String
  image              String?
  kategori           BeritaKategori
  statusPersetujuan  StatusApproval @map("status_persetujuan")
  rejectionNote      String?        @map("rejection_note")
  authorId           String         @map("author_id")

  // Timestamps
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  // Relations
  author             User           @relation("NewsAuthor", fields: [authorId], references: [id])

  @@map("news")
}

model Announcement {
  id         String        @id @default(uuid())
  title      String
  date       DateTime
  location   String?
  content    String
  priority   PriorityLevel
  linkFile   String?       @map("link_file")

  // Timestamps
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  @@map("announcements")
}

model HeroSlide {
  id                String   @id @default(uuid())
  title             String
  subtitle          String
  imageSmall        String   @map("image_small")
  imageMedium       String   @map("image_medium")
  linkPrimaryText   String?  @map("link_primary_text")
  linkPrimaryHref   String?  @map("link_primary_href")
  linkSecondaryText String?  @map("link_secondary_text")
  linkSecondaryHref String?  @map("link_secondary_href")
  isActive          Boolean  @default(true) @map("is_active")
  sortOrder         Int      @default(0) @map("sort_order")

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("hero_slides")
}

model SchoolStat {
  id        String   @id @default(uuid())
  label     String
  value     String
  iconName  String   @map("icon_name")
  isActive  Boolean  @default(true) @map("is_active")
  sortOrder Int      @default(0) @map("sort_order")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("school_stats")
}

model SchoolActivity {
  id              String       @id @default(uuid())
  title           String
  date            DateTime
  information     String
  semester        SemesterType
  tahunPelajaran  String       @map("tahun_pelajaran")
  createdBy       String       @map("created_by")

  // Timestamps
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  creator         User         @relation("ActivityCreator", fields: [createdBy], references: [id])

  @@map("school_activities")
}

model OsisActivity {
  id              String       @id @default(uuid())
  title           String
  description     String
  date            DateTime
  time            String
  location        String
  budget          Int
  participants    Int
  organizer       String
  proposalUrl     String?      @map("proposal_url")
  status          StatusApproval @default(PENDING)
  rejectionNote   String?      @map("rejection_note")
  authorId        String       @map("author_id")

  // Timestamps
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  author          User         @relation("OsisActivityCreator", fields: [authorId], references: [id])

  @@map("osis_activities")
}

model StudentAchievement {
  id                 String         @id @default(uuid())
  siswaId            String         @map("siswa_id")
  title              String
  description        String?
  image              String?
  statusPersetujuan  StatusApproval @map("status_persetujuan")
  category           String?         // akademik, olahraga, seni, dll
  level              String?         // sekolah, kecamatan, provinsi, dll
  achievementDate    DateTime?      @map("achievement_date")
  rejectionNote      String?        @map("rejection_note")

  // Timestamps
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  // Relations
  siswa              Siswa          @relation(fields: [siswaId], references: [id], onDelete: Cascade)

  @@map("student_achievements")
}

model StudentWork {
  id                 String         @id @default(uuid())
  siswaId            String         @map("siswa_id")
  title              String
  description        String?
  workType           WorkType       @map("work_type")
  mediaUrl           String?        @map("media_url")  // For photos (Cloudinary URL)
  videoLink          String?        @map("video_link")  // For YouTube/GDrive links
  category           String?         // seni, teknologi, tulis, dll
  subject            String?         // mata pelajaran terkait
  statusPersetujuan  StatusApproval @map("status_persetujuan")
  rejectionNote      String?        @map("rejection_note")

  // Timestamps
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  // Relations
  siswa              Siswa          @relation(fields: [siswaId], references: [id], onDelete: Cascade)

  @@map("student_works")
}

// =============================================
// SCHOOL FACILITIES & EXTRACURRICULARS
// =============================================

model Facility {
  id          String   @id @default(uuid())
  title       String
  description String?
  image       String?

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("facilities")
}

model Extracurricular {
  id          String   @id @default(uuid())
  title       String
  description String?
  image       String?
  schedule    String?

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("extracurriculars")
}

model Teacher {
  id          String          @id @default(uuid())
  name        String
  position    String
  category    TeacherCategory
  photo       String?
  subject     String?
  description String?
  experience  String?
  sortOrder   Int             @default(0) @map("sort_order")
  isActive    Boolean         @default(true) @map("is_active")

  // Timestamps
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@map("teachers")
}

// =============================================
// ENUMS (Sesuai dengan dbdiagram Anda)
// =============================================

enum TeacherCategory {
  PIMPINAN          @map("pimpinan")
  GURU_MAPEL        @map("guru_mapel")
  STAFF             @map("staff")

  @@map("teacher_category")
}

enum UserRole {
  ADMIN          @map("admin")
  SISWA          @map("siswa")
  OSIS           @map("osis")
  KESISWAAN      @map("kesiswaan")
  PPDB_ADMIN     @map("ppdb_admin")
  PEMBINA_OSIS   @map("pembina_osis")

  @@map("user_role")
}

enum GenderType {
  MALE   @map("male")
  FEMALE @map("female")

  @@map("gender_type")
}

enum PPDBStatus {
  PENDING    @map("pending")
  ACCEPTED   @map("accepted")
  REJECTED   @map("rejected")

  @@map("ppdb_status")
}

enum BeritaKategori {
  ACHIEVEMENT @map("achievement")
  ACTIVITY    @map("activity")

  @@map("berita_kategori")
}

enum StatusApproval {
  APPROVED @map("approved")
  REJECTED @map("rejected")
  PENDING  @map("pending")

  @@map("status_approval")
}

enum PriorityLevel {
  HIGH   @map("high")
  MEDIUM @map("medium")
  LOW    @map("low")

  @@map("priority_level")
}

enum WorkType {
  PHOTO @map("photo")
  VIDEO @map("video")

  @@map("work_type")
}

enum SemesterType {
  GANJIL @map("ganjil")
  GENAP  @map("genap")

  @@map("semester_type")
}

enum NotificationType {
  ACHIEVEMENT_APPROVED    @map("achievement_approved")
  ACHIEVEMENT_REJECTED    @map("achievement_rejected")
  WORK_APPROVED          @map("work_approved")
  WORK_REJECTED          @map("work_rejected")
  GENERAL_INFO           @map("general_info")
  PPDB_UPDATE            @map("ppdb_update")
  SYSTEM_ANNOUNCEMENT    @map("system_announcement")

  @@map("notification_type")
}

// =============================================
// SECURITY & AUDIT LOGGING
// =============================================

model LoginAttempt {
  id            String   @id @default(uuid())
  ip            String    // IPv6 can be up to 45 chars
  username      String
  userAgent     String
  success       Boolean  @default(false)
  failureReason String?
  resolved      Boolean  @default(false) // Mark failed attempts as resolved after successful login
  createdAt     DateTime @default(now())

  // Indexes for performance
  @@index([ip, createdAt])
  @@index([username, createdAt])
  @@index([success, createdAt])
  @@index([resolved, createdAt])
  @@map("login_attempts")
}

// =============================================
// LATENESS TRACKING SYSTEM
// =============================================

model LatenessRecord {
  id          String    @id @default(uuid())
  siswaId     String    @map("siswa_id")
  date        DateTime  @default(now())
  arrivalTime String    @map("arrival_time") // Format: "HH:mm" (e.g., "07:35")
  reason      String?   // Alasan terlambat (optional)
  recordedBy  String    @map("recorded_by") // User ID who scanned

  createdAt   DateTime  @default(now())

  // Relations
  siswa       Siswa     @relation(fields: [siswaId], references: [id], onDelete: Cascade)
  recorder    User      @relation("LatenessRecorder", fields: [recordedBy], references: [id])

  @@index([siswaId, date])
  @@index([date])
  @@index([recordedBy])
  @@map("lateness_records")
}

// =============================================
// NOTIFICATION SYSTEM
// =============================================

model Notification {
  id          String           @id @default(uuid())
  userId      String
  type        NotificationType
  title       String
  message     String
  data        Json?            // Additional data (e.g., achievementId, workId)
  read        Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relations
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read, createdAt])
  @@map("notifications")
}

// =============================================
// RELIGIOUS ACTIVITIES (IBADAH)
// =============================================

model WorshipMenstruationRecord {
  id          String    @id @default(uuid())
  siswaId     String    @map("siswa_id")
  startDate   DateTime  @map("start_date")
  endDate     DateTime? @map("end_date")
  notes       String?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  siswa       Siswa     @relation(fields: [siswaId], references: [id], onDelete: Cascade)

  @@map("worship_menstruation_records")
}

model WorshipAdzanSchedule {
  id          String        @id @default(uuid())
  siswaId     String        @map("siswa_id")
  date        DateTime
  prayerTime  PrayerTime    @map("prayer_time")
  status      TaskStatus    @default(PENDING)

  // Timestamps
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  siswa       Siswa         @relation(fields: [siswaId], references: [id], onDelete: Cascade)

  @@map("worship_adzan_schedules")
}

model WorshipCarpetSchedule {
  id          String      @id @default(uuid())
  date        DateTime
  zone        CarpetZone
  status      TaskStatus  @default(PENDING)
  className   String?     @map("class_name") // Class assigned to this task (e.g. "IX A")

  // Relations
  assignments WorshipCarpetAssignment[]

  // Timestamps
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("worship_carpet_schedules")
}

model WorshipCarpetAssignment {
  id          String                @id @default(uuid())
  scheduleId  String                @map("schedule_id")
  siswaId     String                @map("siswa_id")

  // Relations
  schedule    WorshipCarpetSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  siswa       Siswa                 @relation(fields: [siswaId], references: [id], onDelete: Cascade)

  @@map("worship_carpet_assignments")
}

enum PrayerTime {
  ZUHUR  @map("zuhur")
  ASHAR  @map("ashar")
  JUMAT  @map("jumat")

  @@map("prayer_time")
}

enum TaskStatus {
  PENDING   @map("pending")
  COMPLETED @map("completed")
  MISSED    @map("missed")

  @@map("task_status")
}

enum CarpetZone {
  FLOOR_1 @map("floor_1")
  FLOOR_2 @map("floor_2")

  @@map("carpet_zone")
}

// =============================================
// SITE SETTINGS & FEATURE FLAGS
// =============================================

model SiteSettings {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  type        SettingType @default(STRING)
  category    String   @default("general")
  description String?
  isPublic    Boolean  @default(false) @map("is_public")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("site_settings")
}

enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  DATE
  JSON

  @@map("setting_type")
}

model MaintenanceSchedule {
  id          String   @id @default(uuid())
  title       String
  description String?
  startTime   DateTime @map("start_time")
  endTime     DateTime @map("end_time")
  isActive    Boolean  @default(true) @map("is_active")
  
  // Pages affected (null = all pages)
  affectedPaths String[] @map("affected_paths")
  
  // Message to show during maintenance
  message     String   @default("Website sedang dalam pemeliharaan. Silakan kembali beberapa saat lagi.")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?  @map("created_by")

  @@map("maintenance_schedules")
}
