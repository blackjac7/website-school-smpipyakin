name: CI/CD Pipeline

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: "0 2 * * *" # nightly at 02:00 UTC

env:
  NODE_VERSION: "20"

jobs:
  # Lint and Type Check
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run TypeScript type check
        run: npx tsc --noEmit

  # Unit and Integration Tests
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Reset Database
        run: npm run db:reset
        env:
          DATABASE_URL: postgresql://postgres:password@localhost:5432/testdb

      - name: Build application
        run: npm run build
        env:
          DATABASE_URL: postgresql://postgres:password@localhost:5432/testdb
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME: ${{ secrets.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}

      - name: Start server and run E2E tests (only on push to main)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          npm run start &
          sleep 10
          npm run test:e2e -- --project=chromium
        env:
          DATABASE_URL: postgresql://postgres:password@localhost:5432/testdb
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME: ${{ secrets.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}

  # Smoke E2E for PRs (fast, single browser, small set)
  smoke-e2e:
    name: Smoke E2E (PR)
    runs-on: ubuntu-latest
    needs: lint
    if: github.event_name == 'pull_request'
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache npm & Playwright browsers
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}-playwright-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browser (chromium only)
        run: npx playwright install --with-deps chromium

      - name: Reset Database
        run: npm run db:reset
        env:
          DATABASE_URL: postgresql://postgres:password@localhost:5432/testdb

      - name: Build application
        run: npm run build
        env:
          DATABASE_URL: postgresql://postgres:password@localhost:5432/testdb
          JWT_SECRET: ${{ secrets.JWT_SECRET }}

      - name: Start server and run smoke E2E tests
        run: |
          npm run start &
          sleep 10
          npx playwright test --grep "@smoke" --project=chromium --workers=2 --reporter=list
        env:
          DATABASE_URL: postgresql://postgres:password@localhost:5432/testdb
          JWT_SECRET: ${{ secrets.JWT_SECRET }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  # Security Audit
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Run dependency check
        run: npx depcheck --ignores="@types/*,eslint*,postcss*,tailwindcss,autoprefixer"
        continue-on-error: true

  # Build Check
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME: ${{ secrets.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: .next/
          retention-days: 7

  # Prepare DB snapshot (seed once and upload dump for faster restores)
  prepare-db-snapshot:
    name: Prepare DB Snapshot
    runs-on: ubuntu-latest
    needs: test
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Postgres client (pg_dump)
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Reset and seed database
        run: |
          npm run db:reset
          npm run db:seed-all
        env:
          DATABASE_URL: postgresql://postgres:password@localhost:5432/testdb

      - name: Create DB dump
        run: |
          PGPASSWORD=password pg_dump -h localhost -U postgres -d testdb -F p -f db-dump.sql

      - name: Cache DB dump
        id: cache-db-dump
        uses: actions/cache@v4
        with:
          path: db-dump.sql
          key: db-dump-${{ hashFiles('prisma/**', 'package-lock.json') }}
          restore-keys: |
            db-dump-

      - name: Upload DB dump artifact
        uses: actions/upload-artifact@v4
        with:
          name: db-dump
          path: db-dump.sql
          retention-days: 7

  # Staged E2E (push to main) — medium coverage to catch regressions quickly
  staged-e2e:
    name: Staged E2E (medium)
    runs-on: ubuntu-latest
    needs: [build, prepare-db-snapshot]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache npm & Playwright browsers
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}-playwright-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browser (chromium only)
        run: npx playwright install --with-deps chromium

      - name: Restore DB dump from cache
        id: restore-db-dump-staged
        uses: actions/cache@v4
        with:
          path: db-dump.sql
          key: db-dump-${{ hashFiles('prisma/**', 'package-lock.json') }}
          restore-keys: |
            db-dump-

      - name: Download DB snapshot (fallback)
        if: steps.restore-db-dump-staged.outputs.cache-hit != 'true'
        uses: actions/download-artifact@v4
        with:
          name: db-dump

      - name: Install Postgres client (psql)
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Restore DB from dump
        run: |
          if [ -f db-dump.sql ]; then
            PGPASSWORD=password psql -h localhost -U postgres -d testdb -f db-dump.sql
          fi

      - name: Start server and run staged E2E tests
        run: |
          npm run start &
          sleep 10
          npx playwright test --grep "@medium|@smoke" --project=chromium --workers=2 --reporter=list
        env:
          DATABASE_URL: postgresql://postgres:password@localhost:5432/testdb
          JWT_SECRET: ${{ secrets.JWT_SECRET }}

      - name: Compress Playwright report (on failure)
        if: failure()
        run: |
          if [ -d playwright-report ]; then
            tar -czf playwright-report-staged.tar.gz playwright-report/
          fi

      - name: Upload test results (on failure only)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-staged
          path: playwright-report-staged.tar.gz
          retention-days: 7

  # Full E2E (nightly or push to main) — full browser matrix, longer runtime
  full-e2e:
    name: Full E2E (matrix)
    runs-on: ubuntu-latest
    needs: [build, prepare-db-snapshot, staged-e2e]
    if: github.event_name == 'schedule' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Cache npm & Playwright browsers
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}-playwright-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install Playwright Browsers (all)
        run: npx playwright install --with-deps

      - name: Restore DB dump from cache
        id: restore-db-dump-full
        uses: actions/cache@v4
        with:
          path: db-dump.sql
          key: db-dump-${{ hashFiles('prisma/**', 'package-lock.json') }}
          restore-keys: |
            db-dump-

      - name: Download DB snapshot (fallback)
        if: steps.restore-db-dump-full.outputs.cache-hit != 'true'
        uses: actions/download-artifact@v4
        with:
          name: db-dump

      - name: Install Postgres client (pg_restore)
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Restore DB from dump
        run: |
          if [ -f db-dump.sql ]; then
            PGPASSWORD=password psql -h localhost -U postgres -d testdb -f db-dump.sql
          fi

      - name: Start server and run full E2E tests
        run: |
          npm run start &
          sleep 10
          npx playwright test --workers=4
        env:
          DATABASE_URL: postgresql://postgres:password@localhost:5432/testdb
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME: ${{ secrets.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}

      - name: Compress Playwright report (on failure)
        if: failure()
        run: |
          if [ -d playwright-report ]; then
            tar -czf playwright-report-full.tar.gz playwright-report/
          fi

      - name: Upload test results (on failure only)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-full
          path: playwright-report-full.tar.gz
          retention-days: 30

      - name: Create GitHub issue on full E2E failure
        if: failure()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = `[E2E][FAIL] Full E2E failed on ${context.repo.owner}/${context.repo.repo} (${process.env.GITHUB_REF})`;
            const body = `Full E2E tests failed.\n\nRun details: ${process.env.GITHUB_SERVER_URL}/${context.repo.owner}/${context.repo.repo}/actions/runs/${process.env.GITHUB_RUN_ID}\n\nArtifacts: playwright-report-full (playwright-report-full.tar.gz)\n\nPlease triage and attach relevant failing traces/screenshot artifacts.`;
            await github.rest.issues.create({ owner: context.repo.owner, repo: context.repo.repo, title, body, labels: ["e2e-failure","triage-needed"] });

  # Lighthouse Performance Check
  lighthouse:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: .next/

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          configPath: "./lighthouserc.json"
          uploadArtifacts: true
          temporaryPublicStorage: true
        continue-on-error: true

  # Deploy to Vercel (Production)
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://www.smpipyakin.sch.id
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: "--prod"

  # Deploy to Vercel (Preview)
  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel (Preview)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
