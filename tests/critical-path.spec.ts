import { test, expect } from "@playwright/test";
import { LoginPage } from "./pages/LoginPage";
import { DashboardAdminPage } from "./pages/DashboardPage";
import { prisma } from "../src/lib/prisma"; // Direct DB access for verification

/**
 * Critical Path Tests
 * ===================
 * Focuses on high-value user flows and database integration.
 * Replaces fragile UI tests with robust logic checks.
 */

test.describe("Public Pages Smoke Test", () => {
  // Clear login attempts before tests to avoid rate limiting
  test.beforeAll(async () => {
    try {
      await prisma.loginAttempt.deleteMany();
      console.log("Cleared login attempts before tests");
    } catch (error) {
      console.error("Failed to clear login attempts:", error);
    }
  });

  test("Homepage loads correctly", async ({ page }) => {
    await page.goto("/");
    await expect(page).toHaveTitle(/SMP IP YAKIN/i);
    await expect(page.locator("nav")).toBeVisible();
  });

  test("Login page loads", async ({ page }) => {
    await page.goto("/login");
    // Updated selector to match ID
    await expect(page.locator('#username')).toBeVisible();
  });
});

test.describe("Admin Critical Flow", () => {
  let loginPage: LoginPage;
  let dashboardPage: DashboardAdminPage;
  const uniqueId = Date.now().toString();
  const newsTitle = `Automation Test News ${uniqueId}`;

  test.beforeEach(async ({ page }) => {
    loginPage = new LoginPage(page);
    dashboardPage = new DashboardAdminPage(page);
    await loginPage.loginAs("admin");
  });

  test("Admin can create news and it persists to DB", async ({ page }) => {
    // 1. Navigate to News Management
    await dashboardPage.gotoNews();

    // Debug: screenshot to see where we are
    // await page.screenshot({ path: 'debug-news-page.png' });

    // 2. Open "Add News" Modal
    // Use a more flexible selector to handle potential whitespace or icon interactions
    const addButton = page.locator('button', { hasText: 'Add News' }).first();
    await expect(addButton).toBeVisible({ timeout: 15000 });
    await addButton.click();

    // 3. Fill Form
    await page.fill('input[name="title"]', newsTitle);

    // Fill Date (assuming name="date")
    // If selector fails, we might need to inspect the form code, but let's try standard name
    await page.fill('input[name="date"]', new Date().toISOString().split('T')[0]);

    // Fill Image URL (required field per screenshot)
    await page.fill('input[name="image"]', "https://example.com/test-image.jpg");

    await page.fill('textarea[name="content"]', "This is a test content generated by automation.");

    const categorySelect = page.locator('select[name="kategori"]');
    if (await categorySelect.isVisible()) {
        await categorySelect.selectOption("ACTIVITY");
    }

    // 4. Submit
    await page.click('button:has-text("Save News")');

    // 5. Wait for Result (Success or Failure)
    // We try to find ANY toast message to understand what happened
    // React Hot Toast usually puts text in a div
    const toastMessage = page.locator('div[role="status"]');
    // Or generic text search for "created" or "Failed"

    try {
        await expect(page.locator('text=News created')).toBeVisible({ timeout: 10000 });
    } catch (e) {
        // If success not found, check for error
        const content = await page.content();
        console.log("DEBUG: Page content after submit failure:");
        // Print snippet around "Failed" or "Error"
        if (content.includes("Failed")) {
             console.log("Found 'Failed' text on page.");
        }

        // Check if DB has it anyway?
        const newsItem = await prisma.news.findFirst({
            where: { title: newsTitle }
        });
        console.log("DEBUG: DB Check result:", newsItem);

        throw e; // Re-throw the error
    }

    // 6. VERIFY IN DATABASE
    await expect(async () => {
        const newsItem = await prisma.news.findFirst({
            where: { title: newsTitle }
        });
        expect(newsItem).not.toBeNull();
        expect(newsItem?.title).toBe(newsTitle);
    }).toPass({ timeout: 5000 });

    // 7. Cleanup
    await prisma.news.deleteMany({
        where: { title: newsTitle }
    });
  });
});

test.describe("Security & RBAC", () => {
  test("Student cannot access Admin Dashboard", async ({ page }) => {
    const loginPage = new LoginPage(page);
    await loginPage.loginAs("siswa"); // uses siswa001 / admin123

    // Try to force navigate
    await page.goto("/dashboard-admin");

    // Should be redirected
    // Expect to be back on login page or unauthorized page
    await expect(page).toHaveURL(/\/login|\/unauthorized/);
  });
});
